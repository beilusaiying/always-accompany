# 贝露·与你之诗 — 框架解构与技术方案

> 更新时间: 2026-02-16  
> 本文档两个用途：  
>
> 1. **Fount 框架解构** — 每个模块的说明，beilu 如何适配  
> 2. **记忆层架构方案** — 第四层的技术设计和实现路线

---

## 第一部分：Fount 框架解构

> beilu 基于 Fount 框架运行，但不是 Fount 的插件。
> 下面说明 Fount 每个核心模块的作用，以及 beilu 的策略：✅ 保留 / 🔄 改造 / ❌ 删除

### 1. 运行环境层

| 模块                  | 作用                                             | beilu 策略              |
| --------------------- | ------------------------------------------------ | ----------------------- |
| **Deno 运行时**       | JS/TS 服务端运行环境，替代 Node.js。内置权限控制 | ✅ 保留                  |
| **Express (via npm)** | HTTP 服务器框架，提供路由、中间件                | ✅ 保留                  |
| **deno.json**         | 项目配置，定义 tasks/imports                     | ✅ 保留                  |
| **run.bat / run.sh**  | 启动脚本                                         | 🔄 改造（加 beilu 品牌） |

### 2. 核心服务层

| 模块                          | 文件位置                      | 作用                                          | beilu 策略 |
| ----------------------------- | ----------------------------- | --------------------------------------------- | ---------- |
| **用户认证 (auth)**           | `src/server/auth.mjs`         | 用户登录、会话管理、多用户隔离                | ✅ 保留     |
| **模块加载器 (parts_loader)** | `src/server/parts_loader.mjs` | 动态加载插件(plugins)和壳(shells)，提供热插拔 | ✅ 保留     |
| **配置管理**                  | `src/server/config.mjs`       | 读写 `data/config.json`，管理全局设置         | ✅ 保留     |
| **WebSocket**                 | `src/server/websocket.mjs`    | 实时双向通信（聊天流式输出、状态同步）        | ✅ 保留     |

**说明**：这四个模块是 Fount 的基础设施，和 beilu 的业务逻辑无关。直接用，不改。

### 3. AI 服务层

| 模块                       | 作用                                                     | beilu 策略      |
| -------------------------- | -------------------------------------------------------- | --------------- |
| **AI Source (服务源)**     | 统一的 AI API 代理层。支持 Gemini、OpenAI 格式、本地模型 | ✅ 保留 + 🔄 扩展 |
| **搜索服务源 (search)**    | 提供联网搜索能力（Google Search）                        | ✅ 保留          |
| **翻译服务源 (translate)** | 提供翻译能力（Google Translate）                         | ✅ 保留          |
| **AI 服务生成器**          | 快速创建新的 AI 服务源实例                               | ✅ 保留          |

**扩展需求**：记忆层需要同时调用多个AI（检索AI + 对话AI），需要扩展 AI Source 层支持并发请求。

### 4. Shell 层（用户界面）

| 模块                | 作用                                                           | beilu 策略 |
| ------------------- | -------------------------------------------------------------- | ---------- |
| **beilu-home**      | 首页管理界面（角色卡、预设、世界书、系统设置）                 | 🔄 持续改造 |
| **beilu-chat**      | 聊天界面（对话、消息渲染、流式输出）                           | 🔄 持续改造 |
| **chat (核心引擎)** | `src/public/parts/shells/chat/src/chat.mjs` — 2017行的聊天逻辑 | 🔄 **重写** |

**chat.mjs 重写**详见 [`beilu_worklog_架构审查.md`](beilu_worklog_架构审查.md)

### 5. Plugin 层（功能插件）

| 插件                | 作用                                           | beilu 策略             |
| ------------------- | ---------------------------------------------- | ---------------------- |
| **beilu-preset**    | 预设管理（ST导入、司令员模式、条目排序）       | ✅ 保留（已完善）       |
| **beilu-worldbook** | 世界书管理（条目CRUD、关键词激活、@depth注入） | ✅ 保留（已完善）       |
| **beilu-regex**     | 正则美化系统（思维链折叠、HTML渲染）           | ✅ 保留（已完善）       |
| **beilu-sysinfo**   | 系统信息注入（时间、日期等）                   | ✅ 保留                 |
| **beilu-toggle**    | 功能开关管理                                   | ✅ 保留                 |
| **beilu-web**       | 联网搜索功能                                   | ✅ 保留                 |
| **beilu-agents**    | AI agent 框架（未完成）                        | 🔄 扩展为记忆层的入口   |
| **beilu-files**     | 文件系统操作                                   | 🔄 扩展（记忆文件管理） |
| **beilu-memory**    | 🔴 **新建** — 记忆引擎核心                      | 🆕 新建                 |

### 6. 导入处理器层

| 模块                          | 作用                               | beilu 策略                           |
| ----------------------------- | ---------------------------------- | ------------------------------------ |
| **SillyTavern ImportHandler** | 导入 ST 格式的角色卡、预设、世界书 | ✅ 保留                               |
| **charData.mjs**              | ST 角色卡数据结构定义              | ✅ 保留（beilu-worldbook 已内联常量） |
| **world_info.mjs**            | ST 世界书激活逻辑                  | ✅ 保留                               |

### 7. 前端公共层

| 模块                   | 作用                                                     | beilu 策略 |
| ---------------------- | -------------------------------------------------------- | ---------- |
| **base.css**           | 全局样式（含 `.disabled { pointer-events: none }` 的坑） | 🔄 需要覆盖 |
| **Vue.js**             | 前端框架（beilu-home 使用）                              | ✅ 保留     |
| **DaisyUI + Tailwind** | UI 组件库                                                | ✅ 保留     |
| **marked.js**          | Markdown 渲染                                            | ✅ 保留     |
| **highlight.js**       | 代码高亮                                                 | ✅ 保留     |

### 8. 已删除/禁用的模块

| 模块                     | 原作用                   | 状态           |
| ------------------------ | ------------------------ | -------------- |
| 成就系统                 | 用户操作成就             | ❌ 计划删除     |
| 教程系统                 | 新手引导                 | ❌ 计划删除     |
| is_VividChat             | 区分"有内容"和"空白"聊天 | ❌ 新引擎中移除 |
| chars_speaking_frequency | 多角色自动回复频率       | ❌ 新引擎中移除 |

---

## 第二部分：记忆层架构方案

### 1. 整体数据流

```
用户输入消息
     │
     ▼
┌─────────────────────┐
│   beilu-memory 插件  │
│                     │
│  1. 提取关键词       │──→ 关键词匹配（零成本）
│  2. 读取注入层文件   │      │
│  3. 读取当天记忆     │      ▼
│                     │  找到候选记忆片段
│  4. 可选：调检索AI   │──→ AI 判断关联性（如果关键词匹配不够）
│                     │      │
│  5. 组装记忆上下文   │◀────┘
│     (≤5000~10000 tk)│
└─────────┬───────────┘
          │
          ▼
┌─────────────────────────────────────────────┐
│  发送给对话 AI                               │
│                                             │
│  预设提示词（司令员模式）                     │
│  ┌─────────────────────────────────────┐    │
│  │ 角色卡 + 世界书 + 用户人设           │    │
│  │ 记忆表格（L0 注入层）                │    │
│  │ 当天记忆摘要（热 token）             │    │
│  │ 永久记忆条目                        │    │
│  ├─────────────────────────────────────┤    │
│  │ 历史对话                            │    │
│  ├─────────────────────────────────────┤    │
│  │ [辅助相关记忆]                      │    │ ← 检索AI找到的
│  │ 用户输入                            │    │
│  └─────────────────────────────────────┘    │
│  预设提示词                                  │
└─────────────────────┬───────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────┐
│  AI 输出                                     │
│                                             │
│  思维链（可选）                               │
│  对话内容                                    │
│  ──────────                                 │
│  <memory_log>简短记录</memory_log>           │ ← 解析提取
│  <memory_table>表格更新</memory_table>       │ ← 解析提取
└─────────────────────┬───────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────┐
│  后处理                                      │
│                                             │
│  1. 正则提取 memory_log → 写入当天记忆文件    │
│  2. 正则提取 memory_table → 更新记忆表格      │
│  3. 对话内容 → 正常渲染显示                   │
│  4. 检查记忆条数 → 是否触发整理               │
└─────────────────────────────────────────────┘
```

### 2. 文件存储结构

```
data/users/{用户名}/memory/{角色名}/
│
├── inject/                    ← L0 注入层（每轮必读）
│   ├── core_table.json        ← 记忆表格（AI 会更新）
│   ├── permanent.json         ← "永远记住的事情"（用户可控）
│   └── custom/                ← 用户自定义的注入条目
│       ├── 贝露永远记住的事情.json
│       └── ...（可加减）
│
├── hot/                       ← 当天记忆（热 token）
│   └── 2026-02-16/
│       ├── batch_001.json     ← 第1-10条
│       ├── batch_002.json     ← 第11-20条
│       ├── batch_003.json     ← 第21-30条
│       ├── ...
│       └── day_summary.json   ← 实时更新的当天总结
│
├── cold/                      ← 归档记忆（冷 token）
│   └── 2026/
│       ├── 01/
│       │   ├── 01.json        ← 1月1日总结（≤500字）
│       │   ├── 02.json
│       │   ├── ...
│       │   └── summary.json   ← 1月总结
│       ├── 02/
│       │   ├── 15.json        ← 2月15日总结
│       │   ├── 16.json
│       │   └── summary.json   ← 2月总结
│       └── summary.json       ← 2026年总结
│
└── kv/                        ← KV Memory（事实/实体）
    ├── entities.json          ← 实体数据（人物、地点、物品）
    └── facts.json             ← 事实数据（偏好、习惯、关系）
```

### 3. 记忆条目格式

```json
// batch_001.json — 10条一个文件
{
  "date": "2026-02-16",
  "batch_id": 1,
  "entries": [
    {
      "id": 1,
      "time": "09:15",
      "type": "conversation",
      "summary": "主人问了关于记忆系统的设计，讨论了文件存储方案",
      "keywords": ["记忆系统", "文件存储", "架构设计"],
      "token_count": 45
    },
    {
      "id": 2,
      "time": "09:30",
      "summary": "...",
      "keywords": ["..."],
      "token_count": 38
    }
  ],
  "total_tokens": 420
}
```

```json
// cold/2026/02/16.json — 日总结
{
  "date": "2026-02-16",
  "id": "20260216",
  "summary": "今天主要讨论了beilu记忆层的架构设计...",
  "events": [
    "上午：设计了记忆文件的存储结构",
    "下午：讨论了检索AI的工作流程",
    "晚上：开始编写记忆引擎代码"
  ],
  "token_count": 380,
  "batch_count": 5,
  "total_conversations": 47
}
```

```json
// kv/facts.json — 事实数据库
{
  "facts": [
    { "subject": "主人", "predicate": "喜欢", "object": "蓝色", "confidence": 0.95, "source": "20260215-batch3" },
    { "subject": "主人", "predicate": "生日", "object": "X月X日", "confidence": 1.0, "source": "20260210-batch1" },
    { "subject": "贝露", "predicate": "害怕", "object": "打雷", "confidence": 0.8, "source": "20260212-batch7" }
  ]
}
```

### 4. 检索流程详解

```
用户发送："你还记得上周我们讨论的那个项目吗？"
                    │
                    ▼
          ┌─────────────────┐
          │  Step 1: 关键词  │  ← 零成本，纯文本匹配
          │  提取 "上周"     │
          │  提取 "项目"     │
          │  提取 "讨论"     │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │  Step 2: 范围定位│
          │  "上周" → 计算   │
          │  2026-02-09 ~    │
          │  2026-02-15      │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │  Step 3: 搜索    │
          │                 │
          │  先看月总结      │  ← 快速定位到哪几天
          │  再看日总结      │  ← 找到具体日期
          │  最后看 batch    │  ← 拿到详细内容
          │                 │
          │  关键词匹配：    │
          │  "项目" in       │
          │  keywords/summary│
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │  Step 4: 组装    │
          │                 │
          │  找到 3 条匹配   │
          │  总计 800 token  │
          │  < 5000 预算     │
          │  ✅ 直接注入      │
          └─────────────────┘
```

**关键优化**：先用关键词匹配（零API成本），绝大多数情况够用。只有当关键词匹配不到、或匹配结果太多需要筛选时，才调检索AI。

### 5. 定时任务管理

```
┌──────────────────────────────────────────────────┐
│  beilu 定时任务调度器                             │
│                                                  │
│  触发条件           动作                          │
│  ─────────         ─────                         │
│  记忆 > 50条       拆分文件 + 总结                │
│  用户手动触发       立即执行总结                   │
│  当天结束*          全天总结 + 归档到 cold         │
│  每月1号            上月总结 + 压缩日总结          │
│  每年1月1日         年度总结                       │
│                                                  │
│  * "当天结束" 判定：                              │
│    - 用户主动点击"结束今天"                        │
│    - 隔了一天再打开（检测到日期变化）              │
│    - 用户设置的固定时间（如凌晨3点）               │
│                                                  │
│  API 重试机制：                                   │
│    - 失败后间隔 10 分钟重试（用户可设置）          │
│    - 最大重试 6 次（1小时）                       │
│    - 重试期间不阻塞对话                           │
└──────────────────────────────────────────────────┘
```

### 6. 技术难度分析

#### 🟢 低难度（已有能力或标准实现）

| 项                 | 说明                             | 依赖             |
| ------------------ | -------------------------------- | ---------------- |
| 文件读写           | JSON 文件的 CRUD                 | beilu-files 已有 |
| 日期编号           | `20260216` 格式命名              | 标准 JS Date     |
| 提示词控制输出格式 | 让 AI 用 `<memory_log>` 标签输出 | 司令员模式已有   |
| 正则提取           | 从 AI 回复中提取记忆标签         | beilu-regex 已有 |
| 关键词匹配         | 文本搜索、字符串包含             | 标准 JS          |
| 用户配置           | 阈值、时间间隔等参数             | JSON 配置文件    |

#### 🟡 中等难度（需要新开发，但技术成熟）

| 项         | 说明                           | 实现方式                    |
| ---------- | ------------------------------ | --------------------------- |
| 检索AI调度 | 用户消息 → 先检索 → 再对话     | 串联两次 API 调用           |
| AI输出解析 | 提取 `<memory_log>` 等标签内容 | 正则 + DOM解析              |
| 定时任务   | 日/月/年归档触发               | Deno setTimeout + 日期检测  |
| API重试    | 失败后间隔重试                 | 简单队列 + 指数退避         |
| Token计数  | 估算记忆注入的token量          | 字符数÷4 近似 或用 tiktoken |

#### 🔴 高难度（需要额外技术，建议后期引入）

| 项         | 说明                   | 建议                                               |
| ---------- | ---------------------- | -------------------------------------------------- |
| Vector DB  | 向量语义检索           | **Phase 4 再做**。初期用关键词匹配足够             |
| RAG        | 检索增强生成           | **Phase 3-4**。先做简单版（关键词检索+AI判断）     |
| Embedding  | 文本向量化             | Gemini 提供 `text-embedding-004` API，但初期不需要 |
| KV自动提取 | AI自动识别事实并写入KV | 需要精心设计提示词，但不是技术难点                 |

### 7. 分阶段实现路线

```
Phase 1 — 基础记忆文件系统                     ← 先做这个
──────────────────────────
  · 创建 beilu-memory 插件骨架
  · 文件存储结构（inject/hot/cold/kv 目录）
  · 记忆条目的写入和读取
  · 10条一文件的自动拆分
  · 注入层文件的每轮读取
  · 提示词设计（让AI输出带标签的记忆）
  · 正则提取AI输出中的记忆内容
  
Phase 2 — 记忆注入和输出解析                   ← 核心功能
──────────────────────────
  · AI输出后处理：提取 memory_log → 写入hot文件
  · AI输出后处理：提取 memory_table → 更新core_table
  · 记忆注入：组装注入层+当天记忆 → 放入对话上下文
  · Token预算管理（≤5000~10000）
  · 用户UI：查看/编辑记忆文件
  
Phase 3 — 检索和归档                           ← 智能化
──────────────────────────
  · 关键词检索（零成本匹配）
  · 时间范围定位（"上周"→具体日期）
  · 日总结自动生成（当天结束触发）
  · 月总结自动生成（每月触发）
  · API可用性检测 + 重试机制
  · KV Memory 自动提取
  
Phase 4 — 向量化升级（远期）                   ← 高级特性
──────────────────────────
  · 引入 Embedding API（Gemini text-embedding-004）
  · 语义相似度检索
  · 多AI并发调度优化
  · 冷/热Token智能调度
```

### 8. 主人确认的设计决策

> 以下为 2026-02-16 讨论中主人确认的要点

#### 已确认

| 项                     | 决策                                 | 说明                                           |
| ---------------------- | ------------------------------------ | ---------------------------------------------- |
| **记忆注入方式**       | 单次临时注入，不记录上下文           | 和联网搜索结果一样，附在用户消息旁边，用完即丢 |
| **用户消息也可单次**   | 用户可选择把自己的消息也变为单次注入 | 如包含快照、截图等大内容时                     |
| **多AI协作模式**       | 串行调度，不是并发                   | 检索AI→对话AI→归档AI，一个一个来               |
| **记忆文件格式**       | JSON                                 | 用户可以直接编辑                               |
| **向量数据库初期方案** | JSON + 内存余弦相似度                | 分层检索下可用3-5年                            |
| **Embedding API**      | Gemini text-embedding-004（Phase 4） | 免费额度，768维                                |
| **KV Memory AI**       | Gemini 2.5 Pro 或 2.0 Flash          | 事实提取用便宜模型                             |
| **RAG AI**             | Gemini 2.5 或 2.0 Flash              | 本地接口以后做                                 |

#### 待确认

| #   | 问题                                | 选项                                              |
| --- | ----------------------------------- | ------------------------------------------------- |
| 1   | AI输出记忆用什么格式标签？          | A: XML标签 `<memory_log>` B: JSON块 C: 特殊标记符 |
| 2   | 检索AI和对话AI是否共用同一个API源？ | A: 共用（省配置）B: 独立配置（更灵活）            |
| 3   | 先做什么？                          | A: 先完成chat.mjs重写再做记忆层 B: 并行推进       |

### 9. 补充分析：难度降级

> 经过主人 2026-02-16 的补充说明，原标为"高难度"的项全部降级

#### 原高难度 → 降级后

| 项        | 原难度 | 降级为       | 原因                                                |
| --------- | ------ | ------------ | --------------------------------------------------- |
| 多AI协作  | 🔴 高   | 🟢 低         | 串行 async/await，不需要并发管理                    |
| 记忆注入  | 🟡 中   | 🟢 低         | 单次临时注入 = 不改聊天历史存储，和联网搜索注入一样 |
| Vector DB | 🔴 高   | 🟡 中（远期） | 分层检索下 JSON 方案可用3-5年，不急                 |
| RAG       | 🔴 高   | 🟡 中（远期） | 先用关键词匹配+AI判断，Phase 4再引入embedding       |
| KV提取    | 🔴 高   | 🟡 中         | 本质是提示词工程+JSON读写，不是技术难点             |

#### 向量数据库容量预估

按每天400条记忆计算：

| 时间  | 记忆总条数 | 文件数(10条/文件) | 需要中量？                       |
| ----- | ---------- | ----------------- | -------------------------------- |
| 1个月 | 12,000     | 1,200             | ❌ JSON够                         |
| 1年   | 146,000    | 14,600            | ❌ JSON够（分层检索）             |
| 3年   | 438,000    | 43,800            | ⚠️ 可能需要（如果要全量语义搜索） |
| 5年   | 730,000    | 73,000            | ✅ 建议升级SQLite+向量扩展        |

**但**：主人设计的分层检索（月→日→batch）每次搜索范围很小（几十个文件），不需要全量搜索。所以 JSON 方案实际可用更久。

#### 仍需注意的3个点

1. **AI输出格式稳定性** — `<memory_log>` 标签需要每次正确输出。兜底：格式不对时跳过本轮记忆写入，不崩溃
2. **检索延迟的用户体验** — 先检索再对话，额外1-3秒延迟。UI需显示"正在回忆..."
3. **文件读写并发安全** — 对话后处理写入 + 定时归档读取 可能冲突。需简单文件锁

#### AI操作文件的token管理

主人方案：AI看到文件内容后 → 总结为md → 到达最大token → 发送总结清空上下文。
此功能安排在文件操作系统之后实现。

---

## 第三部分：已修复的代码问题（历史记录）

> 以下是之前审计发现并已修复的问题，保留作为历史参考

### 已修复问题清单

| #   | 严重度 | 模块                     | 简述                                        | 状态                     |
| --- | ------ | ------------------------ | ------------------------------------------- | ------------------------ |
| 1   | 🔴 严重 | beilu-preset / st_import | cleanPresetData 未正确识别系统级条目        | ✅ 已修复 (v13.6)         |
| 2   | 🔴 严重 | base.css + beilu-home    | 全局 .disabled pointer-events:none 阻断交互 | ✅ 已修复                 |
| 3   | 🟡 中   | beilu-preset / main.mjs  | SetData 使用 data._result 反模式            | ✅ 已修复                 |
| 4   | 🟡 中   | beilu-worldbook          | 依赖 Fount 内部模块的硬编码相对路径         | 🔶 部分修复（常量已内联） |
| 5   | 🟢 低   | preset_engine            | BUILTIN_MARKERS 定义冗余                    | 代码异味                 |
| 6   | 🟢 低   | beilu-home/index.mjs     | systemInitialized 事件重复绑定              | 代码异味                 |
| 7   | 🟢 低   | worldbook.mjs            | 导出功能缺少部分 ST 字段                    | 待修复                   |

### chat.mjs 引擎问题（待重写解决）

| #   | 问题         | 根因                                            | 修复方式         |
| --- | ------------ | ----------------------------------------------- | ---------------- |
| 1   | 开场白消失   | addchar() 中 getChatRequest() 在 try 外         | 新引擎中修复     |
| 2   | 开场白消失   | char 未添加到 LastTimeSlice 就调 getChatRequest | 新引擎中修复     |
| 3   | 空白聊天丢失 | is_VividChat 过滤掉只有 greeting 的聊天         | 新引擎中移除概念 |
| 4   | 聊天自动删除 | WebSocket 关闭时 30 分钟后删除"非活跃"聊天      | 新引擎中改为保存 |

详见 [`beilu_worklog_架构审查.md`](beilu_worklog_架构审查.md)

---

## 附录：浏览器诊断脚本库

> 保留供调试使用

### 检查预设条目的 pointer-events

```javascript
document.querySelectorAll('.beilu-preset-entry.disabled').forEach(el => {
  const cs = getComputedStyle(el);
  console.log(el.dataset.id, 'pointer-events:', cs.pointerEvents, 'opacity:', cs.opacity);
});
```

### 检查预设引擎加载状态

```javascript
fetch('/api/parts/plugins:beilu-preset/config/getdata')
  .then(r => r.json())
  .then(data => {
    console.log('active_preset:', data.active_preset);
    console.log('entries count:', data.entries?.length);
    console.log('entries:', data.entries?.map(e => 
      `${e.name} [${e.enabled ? '✓' : '✗'}] ${e.system_prompt ? '系统' : 'D' + e.injection_depth}`
    ));
  });
```

### 检查世界书条目状态

```javascript
fetch('/api/parts/plugins:beilu-worldbook/config/getdata')
  .then(r => r.json())
  .then(data => {
    console.log('worldbook_list:', data.worldbook_list);
    if (data.entries) {
      data.entries.forEach(e => {
        console.log(`  [${e.disable ? '✗' : '✓'}] ${e.comment || '(无名)'} — keys: ${e.key?.join(', ')}`);
      });
    }
  });
