/**
 * memoryPreset.mjs â€” è®°å¿†é¢„è®¾ç®¡ç†æ¨¡å—
 *
 * é€šè¿‡ beilu-memory æ’ä»¶çš„ config æ¥å£ç®¡ç†6ä¸ªå†…ç½®è®°å¿†é¢„è®¾ã€‚
 * æ¯ä¸ªé¢„è®¾æ§åˆ¶è®°å¿†ç³»ç»ŸæŸä¸ªç¯èŠ‚ï¼ˆæ£€ç´¢/æ€»ç»“/å½’æ¡£/ä¿®å¤ï¼‰çš„AIè¡Œä¸ºã€‚
 */

// ===== API é€šä¿¡ =====

const PLUGIN_NAME = 'beilu-memory'
const SSM_API_BASE = '/api/parts/shells:serviceSourceManage'

async function getPluginData() {
	try {
		const resp = await fetch(`/api/parts/plugins:${PLUGIN_NAME}/config/getdata`)
		if (!resp.ok) throw new Error(`HTTP ${resp.status}`)
		return await resp.json()
	} catch (e) {
		console.error('[memoryPreset] getPluginData å¤±è´¥:', e)
		return null
	}
}

/** ä» serviceSourceManage è·å–å·²é…ç½®çš„ AI æœåŠ¡æºåç§°åˆ—è¡¨ */
async function fetchAISourceList() {
	try {
		// å°è¯•ä» SSM è·å– AI æºåˆ—è¡¨
		// æš‚æ—¶è¿”å›ç©ºæ•°ç»„ï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è¾“å…¥ã€‚
		return []
	} catch (e) {
		console.error('[memoryPreset] è·å– AI æœåŠ¡æºåˆ—è¡¨å¤±è´¥:', e)
		return []
	}
}

/**
 * åŠ è½½æŒ‡å®šæºçš„æ¨¡å‹åˆ—è¡¨å¹¶å¡«å……åˆ° datalist
 * @param {string} sourceName 
 */
async function loadModelsForSource(sourceName) {
	if (!sourceName) return
	
	const datalist = document.getElementById('model-list')
	if (!datalist) return

	try {
		// è°ƒç”¨ beilu-memory çš„ getModels æ¥å£
		const res = await setPluginData({
			_action: 'getModels',
			sourceName: sourceName
		})

		if (res.success && Array.isArray(res.models)) {
			datalist.innerHTML = ''
			res.models.forEach(model => {
				const option = document.createElement('option')
				option.value = model
				datalist.appendChild(option)
			})
			console.log(`[memoryPreset] å·²åŠ è½½ ${res.models.length} ä¸ªæ¨¡å‹`)
		} else {
			console.warn('[memoryPreset] åŠ è½½æ¨¡å‹å¤±è´¥:', res.error)
		}
	} catch (e) {
		console.error('[memoryPreset] åŠ è½½æ¨¡å‹å‡ºé”™:', e)
	}
}

async function setPluginData(payload) {
	try {
		const resp = await fetch(`/api/parts/plugins:${PLUGIN_NAME}/config/setdata`, {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(payload),
		})
		if (!resp.ok) throw new Error(`HTTP ${resp.status}`)
		return await resp.json() // ä¿®æ”¹ä¸ºè¿”å› json ä»¥ä¾¿è·å– getModels çš„ç»“æœ
	} catch (e) {
		console.error('[memoryPreset] setPluginData å¤±è´¥:', e)
		return { success: false, error: e.message }
	}
}

// ===== DOM å¼•ç”¨ =====

const dom = {}

function cacheDom() {
	dom.loading = document.getElementById('mp-loading')
	dom.main = document.getElementById('mp-main')
	dom.presetList = document.getElementById('mp-preset-list')
	dom.detail = document.getElementById('mp-detail')

	// è¯¦æƒ…åŒºåŸŸ
	dom.detailId = document.getElementById('mp-detail-id')
	dom.detailName = document.getElementById('mp-detail-name')
	dom.detailToggle = document.getElementById('mp-detail-toggle')
	dom.detailDesc = document.getElementById('mp-detail-desc')
	dom.detailTrigger = document.getElementById('mp-detail-trigger')

	// API é…ç½®
	dom.apiCustom = document.getElementById('mp-api-custom')
	dom.apiFields = document.getElementById('mp-api-fields')
	dom.apiSource = document.getElementById('mp-api-source')
	dom.apiModel = document.getElementById('mp-api-model')
	dom.apiTemperature = document.getElementById('mp-api-temperature')
	dom.apiMaxTokens = document.getElementById('mp-api-max-tokens')

	// æç¤ºè¯
	dom.promptList = document.getElementById('mp-prompt-list')
	dom.addPrompt = document.getElementById('mp-add-prompt')

	// æ³¨å…¥æç¤ºè¯ (Injection Prompts)
	dom.injectionList = document.getElementById('mp-injection-list')

	// æ“ä½œ
	dom.previewPresetBtn = document.getElementById('mp-preview-preset-btn')
	dom.saveBtn = document.getElementById('mp-save-btn')
	dom.status = document.getElementById('mp-status')

	// é¢„è®¾é¢„è§ˆé¢æ¿
	dom.presetPreviewPanel = document.getElementById('mp-preset-preview-panel')
	dom.presetPreviewStats = document.getElementById('mp-preset-preview-stats')
	dom.presetPreviewContent = document.getElementById('mp-preset-preview-content')
	dom.presetPreviewClose = document.getElementById('mp-preset-preview-close')
	dom.presetPreviewCopy = document.getElementById('mp-preset-preview-copy')

	// è¿è¡Œæµ‹è¯•é¢æ¿
	dom.runPanel = document.getElementById('mp-run-panel')
	dom.runTitle = document.getElementById('mp-run-title')
	dom.runClose = document.getElementById('mp-run-close')
	dom.runStartBtn = document.getElementById('mp-run-start-btn')
	dom.runResultTime = document.getElementById('mp-run-result-time')
	dom.runThinking = document.getElementById('mp-run-thinking')
	dom.runThinkingArrow = document.getElementById('mp-run-thinking-arrow')
	dom.runThinkingContent = document.getElementById('mp-run-thinking-content')
	dom.runOperations = document.getElementById('mp-run-operations')
	dom.runOperationsList = document.getElementById('mp-run-operations-list')
	dom.runReply = document.getElementById('mp-run-reply')
	dom.runReplyContent = document.getElementById('mp-run-reply-content')
	dom.runError = document.getElementById('mp-run-error')
	dom.runErrorContent = document.getElementById('mp-run-error-content')

	// è®°å¿†ç»´æŠ¤æŒ‰é’®
	dom.endDayBtn = document.getElementById('mem-end-day-btn')
	dom.hotToWarmBtn = document.getElementById('mem-hot-warm-btn')
	dom.warmToColdBtn = document.getElementById('mem-warm-cold-btn')
	dom.maintenanceStatus = document.getElementById('mem-maintenance-status')
}

// ===== çŠ¶æ€ =====

let presets = []
let injectionPrompts = []
let selectedPresetId = null
let aiSourceList = []

// ===== æ¸²æŸ“é€»è¾‘ =====

async function refreshPresets() {
	const data = await getPluginData()
	if (data) {
		presets = data.memory_presets || []
		injectionPrompts = data.injection_prompts || []
	} else {
		presets = []
		injectionPrompts = []
	}
	renderPresetList()
	renderInjectionList()
}

function renderPresetList() {
	if (!dom.presetList) return
	dom.presetList.innerHTML = ''

	presets.forEach(preset => {
		const item = document.createElement('div')
		item.className = `p-3 rounded-lg border border-base-300 cursor-pointer hover:bg-base-200 transition-colors ${preset.id === selectedPresetId ? 'bg-base-200 border-primary' : ''}`
		item.onclick = () => selectPreset(preset.id)

		const statusColor = preset.enabled ? 'text-success' : 'text-base-content/30'
		const statusIcon = preset.enabled ? 'â—' : 'â—‹'

		item.innerHTML = `
			<div class="flex items-center justify-between mb-1">
				<div class="font-bold flex items-center gap-2">
					<span class="${statusColor} text-xs">${statusIcon}</span>
					<span>${escapeHtml(preset.name)}</span>
					<span class="text-xs opacity-50 font-mono">${preset.id}</span>
				</div>
				${preset.builtin ? '<span class="badge badge-xs badge-ghost">å†…ç½®</span>' : ''}
			</div>
			<div class="text-xs opacity-70 line-clamp-2">${escapeHtml(preset.description)}</div>
		`
		dom.presetList.appendChild(item)
	})
}

function selectPreset(id) {
	selectedPresetId = id
	renderPresetList() // æ›´æ–°é«˜äº®

	const preset = presets.find(p => p.id === id)
	if (!preset) return

	// å¡«å……è¯¦æƒ…
	dom.detail.style.display = 'block'
	dom.detailId.textContent = preset.id
	dom.detailName.textContent = preset.name
	dom.detailToggle.checked = preset.enabled
	dom.detailDesc.value = preset.description
	dom.detailTrigger.textContent = preset.trigger === 'auto_on_message' ? 'è‡ªåŠ¨(æ¯æ¡æ¶ˆæ¯)' :
		preset.trigger === 'auto_on_threshold' ? 'è‡ªåŠ¨(é˜ˆå€¼è§¦å‘)' :
		preset.trigger === 'manual_button' ? 'æ‰‹åŠ¨è§¦å‘' : preset.trigger

	// API é…ç½®
	dom.apiSource.value = preset.api_config?.source || ''
	dom.apiModel.value = preset.api_config?.model || 'gemini-2.0-flash'
	dom.apiTemperature.value = preset.api_config?.temperature ?? 0.3
	dom.apiMaxTokens.value = preset.api_config?.max_tokens ?? 2000
	dom.apiCustom.checked = !!preset.api_config?.use_custom

	updateApiFieldsState()

	// å°è¯•åŠ è½½æ¨¡å‹åˆ—è¡¨
	if (preset.api_config?.use_custom && preset.api_config?.source) {
		loadModelsForSource(preset.api_config.source)
	}

	// æ¸²æŸ“æç¤ºè¯åˆ—è¡¨
	renderPromptList(preset)
}

function updateApiFieldsState() {
	const useCustom = dom.apiCustom.checked
	dom.apiFields.style.display = useCustom ? 'grid' : 'none'
	// å¦‚æœä¸ä½¿ç”¨è‡ªå®šä¹‰ï¼Œæ¸…ç©ºæºé€‰æ‹©ï¼ˆè§†è§‰ä¸Šï¼Œå®é™…ä¿å­˜æ—¶ä¼šå¤„ç†ï¼‰
	if (!useCustom) {
		// dom.apiSource.value = '' 
	}
}

function renderPromptList(preset) {
	dom.promptList.innerHTML = ''
	preset.prompts.forEach((p, index) => {
		const item = document.createElement('div')
		item.className = 'collapse collapse-arrow border border-base-300 bg-base-100 mb-2'
		
		const isBuiltin = p.builtin
		const roleBadge = p.role === 'system' ? 'badge-primary' : p.role === 'user' ? 'badge-secondary' : 'badge-ghost'
		
		item.innerHTML = `
			<input type="checkbox" /> 
			<div class="collapse-title flex items-center gap-2 min-h-0 py-2">
				<span class="badge badge-sm ${roleBadge}">${p.role}</span>
				<span class="text-xs font-mono opacity-50">${p.identifier || 'prompt'}</span>
				${!p.enabled ? '<span class="text-error text-xs">(å·²ç¦ç”¨)</span>' : ''}
				<div class="flex-grow"></div>
				${isBuiltin ? '<span class="badge badge-xs badge-outline">é”å®š</span>' : ''}
			</div>
			<div class="collapse-content">
				<div class="form-control w-full mb-2">
					<label class="label py-1"><span class="label-text text-xs">Role</span></label>
					<select class="select select-bordered select-xs w-full" ${isBuiltin ? 'disabled' : ''} onchange="updatePromptRole('${preset.id}', ${index}, this.value)">
						<option value="system" ${p.role === 'system' ? 'selected' : ''}>system</option>
						<option value="user" ${p.role === 'user' ? 'selected' : ''}>user</option>
						<option value="assistant" ${p.role === 'assistant' ? 'selected' : ''}>assistant</option>
					</select>
				</div>
				<div class="form-control w-full mb-2">
					<label class="label py-1"><span class="label-text text-xs">Content (æ”¯æŒå®æ›¿æ¢)</span></label>
					<textarea class="textarea textarea-bordered text-xs font-mono h-32 leading-tight" 
						${isBuiltin && p.content === '{{chat_history}}' ? 'disabled' : ''}
						onchange="updatePromptContent('${preset.id}', ${index}, this.value)">${escapeHtml(p.content)}</textarea>
				</div>
				<div class="flex justify-between items-center mt-2">
					<label class="label cursor-pointer gap-2">
						<span class="label-text text-xs">å¯ç”¨</span> 
						<input type="checkbox" class="toggle toggle-xs" ${p.enabled ? 'checked' : ''} 
							onchange="updatePromptEnabled('${preset.id}', ${index}, this.checked)" />
					</label>
					${p.deletable ? `<button class="btn btn-xs btn-error btn-outline" onclick="deletePrompt('${preset.id}', ${index})">åˆ é™¤</button>` : ''}
				</div>
			</div>
		`
		dom.promptList.appendChild(item)
	})
}

// ===== æ³¨å…¥æç¤ºè¯æ¸²æŸ“ =====

function renderInjectionList() {
	if (!dom.injectionList) return
	dom.injectionList.innerHTML = ''

	injectionPrompts.forEach((inj, index) => {
		const item = document.createElement('div')
		item.className = 'collapse collapse-arrow border border-base-300 bg-base-100 mb-2'
		
		const autoModeBadge = inj.autoMode === 'always' ? 'badge-success' : 
							  inj.autoMode === 'file' ? 'badge-info' : 'badge-ghost'
		const autoModeText = inj.autoMode === 'always' ? 'å¸¸é©»' : 
							 inj.autoMode === 'file' ? 'æ–‡ä»¶æ¨¡å¼' : 'æ‰‹åŠ¨'

		item.innerHTML = `
			<input type="checkbox" /> 
			<div class="collapse-title flex items-center gap-2 min-h-0 py-2">
				<span class="badge badge-sm ${autoModeBadge}">${autoModeText}</span>
				<span class="font-bold text-sm">${escapeHtml(inj.name)}</span>
				${!inj.enabled ? '<span class="text-error text-xs">(å·²ç¦ç”¨)</span>' : ''}
				<div class="flex-grow"></div>
				<span class="text-xs opacity-50">Depth: ${inj.depth}</span>
			</div>
			<div class="collapse-content">
				<div class="grid grid-cols-2 gap-2 mb-2">
					<div class="form-control">
						<label class="label py-1"><span class="label-text text-xs">åç§°</span></label>
						<input type="text" class="input input-bordered input-xs" value="${escapeHtml(inj.name)}" 
							onchange="updateInjName('${inj.id}', this.value)" />
					</div>
					<div class="form-control">
						<label class="label py-1"><span class="label-text text-xs">è§¦å‘æ¨¡å¼</span></label>
						<select class="select select-bordered select-xs" onchange="updateInjMode('${inj.id}', this.value)">
							<option value="always" ${inj.autoMode === 'always' ? 'selected' : ''}>Always (å¸¸é©»)</option>
							<option value="file" ${inj.autoMode === 'file' ? 'selected' : ''}>File (æ–‡ä»¶æ¨¡å¼)</option>
							<option value="manual" ${inj.autoMode === 'manual' ? 'selected' : ''}>Manual (æ‰‹åŠ¨)</option>
						</select>
					</div>
				</div>
				<div class="grid grid-cols-3 gap-2 mb-2">
					<div class="form-control">
						<label class="label py-1"><span class="label-text text-xs">Role</span></label>
						<select class="select select-bordered select-xs" onchange="updateInjRole('${inj.id}', this.value)">
							<option value="system" ${inj.role === 'system' ? 'selected' : ''}>system</option>
							<option value="user" ${inj.role === 'user' ? 'selected' : ''}>user</option>
						</select>
					</div>
					<div class="form-control">
						<label class="label py-1"><span class="label-text text-xs">Depth (0=æœ€åº•)</span></label>
						<input type="number" class="input input-bordered input-xs" value="${inj.depth}" 
							onchange="updateInjDepth('${inj.id}', this.value)" />
					</div>
					<div class="form-control">
						<label class="label py-1"><span class="label-text text-xs">Order</span></label>
						<input type="number" class="input input-bordered input-xs" value="${inj.order}" 
							onchange="updateInjOrder('${inj.id}', this.value)" />
					</div>
				</div>
				<div class="form-control w-full mb-2">
					<label class="label py-1"><span class="label-text text-xs">Content (æ”¯æŒå®æ›¿æ¢)</span></label>
					<textarea class="textarea textarea-bordered text-xs font-mono h-32 leading-tight" 
						onchange="updateInjContent('${inj.id}', this.value)">${escapeHtml(inj.content)}</textarea>
				</div>
				<div class="flex justify-between items-center mt-2">
					<label class="label cursor-pointer gap-2">
						<span class="label-text text-xs">å¯ç”¨</span> 
						<input type="checkbox" class="toggle toggle-xs" ${inj.enabled ? 'checked' : ''} 
							onchange="updateInjEnabled('${inj.id}', this.checked)" />
					</label>
					<button class="btn btn-xs btn-ghost" onclick="previewInj('${inj.id}')">é¢„è§ˆ</button>
				</div>
			</div>
		`
		dom.injectionList.appendChild(item)
	})
}

// æš´éœ²ç»™ HTML onclick çš„è¾…åŠ©å‡½æ•° (æŒ‚è½½åˆ° window)
window.updatePromptRole = (presetId, index, role) => {
	const preset = presets.find(p => p.id === presetId)
	if (preset && preset.prompts[index]) preset.prompts[index].role = role
}
window.updatePromptContent = (presetId, index, content) => {
	const preset = presets.find(p => p.id === presetId)
	if (preset && preset.prompts[index]) preset.prompts[index].content = content
}
window.updatePromptEnabled = (presetId, index, enabled) => {
	const preset = presets.find(p => p.id === presetId)
	if (preset && preset.prompts[index]) preset.prompts[index].enabled = enabled
}
window.deletePrompt = async (presetId, index) => {
	if (!confirm('ç¡®å®šåˆ é™¤æ­¤æç¤ºè¯æ¡ç›®å—ï¼Ÿ')) return
	const ok = await setPluginData({
		_action: 'removePresetPrompt',
		presetId,
		promptIndex: index
	})
	if (ok) refreshPresets()
}

// æ³¨å…¥æç¤ºè¯æ›´æ–°å‡½æ•°
window.updateInjName = async (id, val) => {
	await setPluginData({ _action: 'updateInjectionPrompt', injectionId: id, name: val })
}
window.updateInjMode = async (id, val) => {
	await setPluginData({ _action: 'updateInjectionPrompt', injectionId: id, autoMode: val })
	refreshPresets() // åˆ·æ–°ä»¥æ›´æ–°å¾½ç« 
}
window.updateInjRole = async (id, val) => {
	await setPluginData({ _action: 'updateInjectionPrompt', injectionId: id, role: val })
}
window.updateInjDepth = async (id, val) => {
	await setPluginData({ _action: 'updateInjectionPrompt', injectionId: id, depth: val })
}
window.updateInjOrder = async (id, val) => {
	await setPluginData({ _action: 'updateInjectionPrompt', injectionId: id, order: val })
}
window.updateInjContent = async (id, val) => {
	await setPluginData({ _action: 'updateInjectionPrompt', injectionId: id, content: val })
}
window.updateInjEnabled = async (id, val) => {
	await setPluginData({ _action: 'updateInjectionPrompt', injectionId: id, enabled: val })
	refreshPresets() // åˆ·æ–°ä»¥æ›´æ–°çŠ¶æ€
}
window.previewInj = async (id) => {
	const res = await setPluginData({ _action: 'previewInjectionPrompt', injectionId: id })
	if (res.success) {
		alert(`é¢„è§ˆ (${res.name}):\n\n${res.preview}\n\n(Chars: ${res.charCount}, Tokens: ~${res.estimatedTokens})`)
	} else {
		alert('é¢„è§ˆå¤±è´¥: ' + res.error)
	}
}

function showStatus(msg, duration = 3000) {
	if (!dom.status) return
	dom.status.textContent = msg
	dom.status.style.opacity = '1'
	setTimeout(() => {
		dom.status.style.opacity = '0'
	}, duration)
}

function showMaintenanceStatus(msg, duration = 3000) {
	if (!dom.maintenanceStatus) return
	dom.maintenanceStatus.textContent = msg
	dom.maintenanceStatus.style.opacity = '1'
	setTimeout(() => {
		dom.maintenanceStatus.style.opacity = '0'
	}, duration)
}

// ===== äº‹ä»¶ç»‘å®š =====

function bindEvents() {
	// API è‡ªå®šä¹‰å¼€å…³
	dom.apiCustom?.addEventListener('change', () => {
		updateApiFieldsState()
		const useCustom = dom.apiCustom.checked
		if (!useCustom) {
			dom.apiSource.value = ''
			// æ¸…ç©ºæ¨¡å‹åˆ—è¡¨
			const datalist = document.getElementById('model-list')
			if (datalist) datalist.innerHTML = ''
		} else {
			// å¦‚æœé€‰ä¸­äº†æºï¼Œå°è¯•åŠ è½½æ¨¡å‹
			if (dom.apiSource.value) {
				loadModelsForSource(dom.apiSource.value)
			}
		}
	})

	// æºé€‰æ‹©å˜åŒ–æ—¶åŠ è½½æ¨¡å‹
	dom.apiSource?.addEventListener('change', () => {
		if (dom.apiCustom.checked && dom.apiSource.value) {
			loadModelsForSource(dom.apiSource.value)
		}
	})

	// æ·»åŠ  datalist ç”¨äºæ¨¡å‹è‡ªåŠ¨è¡¥å…¨
	if (dom.apiModel && !document.getElementById('model-list')) {
		const datalist = document.createElement('datalist')
		datalist.id = 'model-list'
		document.body.appendChild(datalist)
		dom.apiModel.setAttribute('list', 'model-list')
	}

	// æ·»åŠ æç¤ºè¯
	dom.addPrompt?.addEventListener('click', async () => {
		if (!selectedPresetId) return

		const ok = await setPluginData({
			_action: 'addPresetPrompt',
			presetId: selectedPresetId,
			role: 'system',
			content: '',
		})
		if (ok) {
			await refreshPresets()
			showStatus('âœ… å·²æ·»åŠ æ–°æ¡ç›®', 2000)
		} else {
			showStatus('âŒ æ·»åŠ å¤±è´¥', 3000)
		}
	})

	// ä¿å­˜æŒ‰é’®
	dom.saveBtn?.addEventListener('click', async () => {
		if (!selectedPresetId) return

		const preset = presets.find(p => p.id === selectedPresetId)
		if (!preset) return

		showStatus('ä¿å­˜ä¸­...')

		// 1. ä¿å­˜é¢„è®¾å…ƒæ•°æ®
		const metaOk = await setPluginData({
			_action: 'updateMemoryPreset',
			presetId: selectedPresetId,
			enabled: dom.detailToggle.checked,
			description: dom.detailDesc.value,
			api_config: {
				use_custom: dom.apiCustom.checked,
				source: dom.apiSource.value,
				model: dom.apiModel.value,
				temperature: parseFloat(dom.apiTemperature.value) || 0.3,
				max_tokens: parseInt(dom.apiMaxTokens.value, 10) || 2000,
			},
		})

		// 2. ä¿å­˜æ¯ä¸ª prompt çš„å†…å®¹
		let allOk = metaOk && metaOk.success !== false
		for (let i = 0; i < preset.prompts.length; i++) {
			const p = preset.prompts[i]
			// è·³è¿‡å†…ç½®çš„ {{chat_history}}
			if (p.builtin && p.content === '{{chat_history}}') continue

			const pOk = await setPluginData({
				_action: 'updatePresetPrompt',
				presetId: selectedPresetId,
				promptIndex: i,
				content: p.content,
				enabled: p.enabled,
			})
			if (!pOk || pOk.success === false) allOk = false
		}

		if (allOk) {
			await refreshPresets()
			showStatus('âœ… ä¿å­˜æˆåŠŸ', 2000)
		} else {
			showStatus('âš ï¸ éƒ¨åˆ†ä¿å­˜å¤±è´¥', 3000)
		}
	})

	// ===== è®°å¿†ç»´æŠ¤æŒ‰é’® =====

	// ğŸŒ™ ç»“æŸä»Šå¤©
	dom.endDayBtn?.addEventListener('click', async () => {
		if (!confirm('ç¡®å®šè¦æ‰§è¡Œæ—¥ç»ˆå½’æ¡£å—ï¼Ÿ\n\nè¿™å°†ï¼š\nâ€¢ å°†ä»Šæ—¥äº‹ä»¶æ€»ç»“å†™å…¥æ¸©å±‚\nâ€¢ å½’æ¡£ä¸´æ—¶è®°å¿†å’Œçƒ­è®°å¿†\nâ€¢ æ¸…ç©ºå½“å¤©è¡¨æ ¼\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return

		dom.endDayBtn.disabled = true
		dom.endDayBtn.textContent = 'â³ å½’æ¡£ä¸­...'
		showMaintenanceStatus('æ­£åœ¨æ‰§è¡Œæ—¥ç»ˆå½’æ¡£...')

		try {
			const resp = await fetch(`/api/parts/plugins:${PLUGIN_NAME}/config/setdata`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ _action: 'endDay' }),
			})
			if (!resp.ok) throw new Error(`HTTP ${resp.status}`)
			const result = await resp.json()

			// æ˜¾ç¤ºç»“æœ
			let msg = `âœ… æ—¥ç»ˆå½’æ¡£å®Œæˆ (${result.date})\n`
			result.steps.forEach(s => {
				msg += `â€¢ Step ${s.step}: ${s.status === 'done' ? 'æˆåŠŸ' : s.status}\n`
			})
			alert(msg)
			showMaintenanceStatus('âœ… æ—¥ç»ˆå½’æ¡£å®Œæˆ', 5000)
		} catch (e) {
			console.error('[memoryPreset] æ—¥ç»ˆå½’æ¡£å¤±è´¥:', e)
			showMaintenanceStatus('âŒ æ—¥ç»ˆå½’æ¡£å¤±è´¥: ' + e.message, 5000)
			alert('å½’æ¡£å¤±è´¥: ' + e.message)
		} finally {
			dom.endDayBtn.disabled = false
			dom.endDayBtn.textContent = 'ğŸŒ™ ç»“æŸä»Šå¤© (æ—¥ç»ˆå½’æ¡£)'
		}
	})

	// ğŸ”¥ çƒ­â†’æ¸©
	dom.hotToWarmBtn?.addEventListener('click', async () => {
		if (!confirm('ç¡®å®šè¦æ‰‹åŠ¨è§¦å‘çƒ­è®°å¿†å½’æ¡£å—ï¼Ÿ\n(æ¸…ç†è¿‡æœŸæ¡ç›®åˆ°æ¸©å±‚)')) return
		showMaintenanceStatus('æ­£åœ¨å½’æ¡£çƒ­è®°å¿†...')
		try {
			const res = await setPluginData({ _action: 'archiveHotToWarm' })
			if (res.success) {
				alert(`âœ… å½’æ¡£å®Œæˆ\n#7 å½’æ¡£: ${res.remember_archived} æ¡\n#8 å½’æ¡£: ${res.forever_archived} æ¡`)
				showMaintenanceStatus('âœ… çƒ­è®°å¿†å½’æ¡£å®Œæˆ')
			} else {
				throw new Error(res.error)
			}
		} catch (e) {
			showMaintenanceStatus('âŒ å¤±è´¥: ' + e.message)
		}
	})

	// â„ï¸ æ¸©â†’å†·
	dom.warmToColdBtn?.addEventListener('click', async () => {
		if (!confirm('ç¡®å®šè¦æ‰‹åŠ¨è§¦å‘å†·å½’æ¡£å—ï¼Ÿ\n(ç§»åŠ¨30å¤©å‰çš„æ¸©è®°å¿†åˆ°å†·å±‚)')) return
		showMaintenanceStatus('æ­£åœ¨å½’æ¡£å†·è®°å¿†...')
		try {
			const res = await setPluginData({ _action: 'archiveWarmToCold' })
			if (res.success) {
				alert(`âœ… å½’æ¡£å®Œæˆ\nç§»åŠ¨äº† ${res.moved} ä¸ªæ–‡ä»¶åˆ°å†·å±‚`)
				showMaintenanceStatus('âœ… å†·è®°å¿†å½’æ¡£å®Œæˆ')
			} else {
				throw new Error(res.error)
			}
		} catch (e) {
			showMaintenanceStatus('âŒ å¤±è´¥: ' + e.message)
		}
	})

	// ===== é¢„è§ˆä¸æµ‹è¯• =====

	dom.previewPresetBtn?.addEventListener('click', async () => {
		if (!selectedPresetId) return
		
		// 1. è·å–é¢„è§ˆæ•°æ®
		const res = await setPluginData({
			_action: 'previewMemoryPreset',
			presetId: selectedPresetId
		})

		if (res.error) {
			alert('é¢„è§ˆå¤±è´¥: ' + res.error)
			return
		}

		// 2. æ¸²æŸ“é¢„è§ˆé¢æ¿
		renderPresetPreview(res)
		dom.presetPreviewPanel.style.display = 'flex'
	})

	dom.presetPreviewClose?.addEventListener('click', () => {
		dom.presetPreviewPanel.style.display = 'none'
	})

	dom.presetPreviewCopy?.addEventListener('click', () => {
		const text = dom.presetPreviewContent.innerText
		navigator.clipboard.writeText(text).then(() => {
			const originalText = dom.presetPreviewCopy.textContent
			dom.presetPreviewCopy.textContent = 'å·²å¤åˆ¶!'
			setTimeout(() => dom.presetPreviewCopy.textContent = originalText, 1500)
		}).catch(err => {
			console.error('[memoryPreset] å¤åˆ¶å¤±è´¥:', err)
		})
	})

	// è¿è¡Œæµ‹è¯•
	dom.runStartBtn?.addEventListener('click', async () => {
		if (!selectedPresetId) return
		
		dom.runPanel.style.display = 'flex'
		dom.runTitle.textContent = `è¿è¡Œæµ‹è¯•: ${selectedPresetId}`
		
		// é‡ç½® UI
		dom.runResultTime.textContent = ''
		dom.runThinking.style.display = 'none'
		dom.runOperations.style.display = 'none'
		dom.runReply.style.display = 'none'
		dom.runError.style.display = 'none'
		
		// æ˜¾ç¤º loading çŠ¶æ€
		dom.runReply.style.display = ''
		dom.runReplyContent.textContent = 'â³ AI æ€è€ƒä¸­...'

		try {
			const res = await setPluginData({
				_action: 'runMemoryPreset',
				presetId: selectedPresetId,
				// å¯é€‰ï¼šä¼ é€’æ¨¡æ‹Ÿçš„ chatHistory
				chatHistory: 'User: ä½ å¥½\nChar: ä½ å¥½å‘€ï¼ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ' 
			})

			if (res.success) {
				renderRunResult(res)
			} else {
				renderRunError(res.error || 'æœªçŸ¥é”™è¯¯')
			}
		} catch (err) {
			console.error('[memoryPreset] è¿è¡Œè®°å¿†AIå¤±è´¥:', err)
			renderRunError(err.message)
		}
	})

	dom.runClose?.addEventListener('click', () => {
		dom.runPanel.style.display = 'none'
	})

	// æ€ç»´é“¾æŠ˜å 
	dom.runThinkingArrow?.parentElement.addEventListener('click', () => {
		const content = dom.runThinkingContent
		const arrow = dom.runThinkingArrow
		if (content.style.display === 'none') {
			content.style.display = 'block'
			arrow.textContent = 'â–¼'
		} else {
			content.style.display = 'none'
			arrow.textContent = 'â–¶'
		}
	})
}

// ===== é¢„è§ˆæ¸²æŸ“ =====

function renderPresetPreview(data) {
	if (dom.presetPreviewStats) {
		dom.presetPreviewStats.innerHTML = `
			<div class="badge badge-neutral">æ€»å­—ç¬¦: ${data.totalChars}</div>
			<div class="badge badge-neutral">é¢„ä¼° Token: ${data.estimatedTokens}</div>
		`
	}

	if (dom.presetPreviewContent) {
		dom.presetPreviewContent.innerHTML = ''
		
		// å±•å¼€çŠ¶æ€è·Ÿè¸ª
		const expandedPreviewItems = new Set()

		data.prompts.forEach(p => {
			const card = document.createElement('div')
			card.className = 'border border-base-300 rounded-lg mb-3 overflow-hidden bg-base-100'
			
			const headerDiv = document.createElement('div')
			headerDiv.className = 'bg-base-200 p-2 text-xs font-bold flex items-center gap-2 cursor-pointer select-none'
			const roleColor = p.role === 'system' ? 'text-primary' : p.role === 'user' ? 'text-secondary' : 'text-accent'
			
			// é¢„è§ˆæ‘˜è¦ï¼ˆå–å‰80å­—ç¬¦ï¼‰
			const preview = p.preview.replace(/\n/g, ' ').substring(0, 80)
			
			headerDiv.innerHTML = `
				<span class="mp-pp-arrow">â–¶</span>
				<span class="${roleColor} uppercase">${p.role}</span>
				<span class="opacity-50">#${p.index}</span>
				<span class="flex-grow opacity-60 font-normal truncate ml-2">${escapeHtml(preview)}${p.charCount > 80 ? '...' : ''}</span>
				<span class="badge badge-xs">${p.charCount} chars</span>
			`

			const bodyDiv = document.createElement('div')
			bodyDiv.className = 'p-3 text-xs font-mono whitespace-pre-wrap border-t border-base-300'
			bodyDiv.style.display = 'none'
			bodyDiv.textContent = p.preview

			// ç‚¹å‡»å±•å¼€/æŠ˜å 
			headerDiv.addEventListener('click', () => {
				const isExpanded = bodyDiv.style.display !== 'none'
				if (isExpanded) {
					expandedPreviewItems.delete(p.identifier)
					bodyDiv.style.display = 'none'
					headerDiv.querySelector('.mp-pp-arrow').textContent = 'â–¶'
					// æ¢å¤é¢„è§ˆæ–‡å­—
					const previewSpan = headerDiv.querySelector('.flex-grow')
					if (previewSpan) previewSpan.textContent = preview + (p.charCount > 80 ? '...' : '')
				} else {
					expandedPreviewItems.add(p.identifier)
					bodyDiv.style.display = ''
					headerDiv.querySelector('.mp-pp-arrow').textContent = 'â–¼'
					// æ¸…é™¤é¢„è§ˆæ–‡å­—
					const previewSpan = headerDiv.querySelector('.flex-grow')
					if (previewSpan) previewSpan.textContent = ''
				}
			})

			card.appendChild(headerDiv)
			card.appendChild(bodyDiv)
			dom.presetPreviewContent.appendChild(card)
		})
	}
}

// ===== è¿è¡Œç»“æœæ¸²æŸ“ =====

function renderRunResult(result) {
	// æ—¶é—´æˆ³
	if (dom.runResultTime) {
		const ts = result.timestamp ? new Date(result.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString()
		dom.runResultTime.textContent = `${result.presetName || result.presetId || ''} Â· ${ts}`
	}

	// æ€ç»´é“¾
	if (result.thinking) {
		if (dom.runThinking) dom.runThinking.style.display = ''
		if (dom.runThinkingContent) dom.runThinkingContent.textContent = result.thinking
		if (dom.runThinkingArrow) dom.runThinkingArrow.textContent = 'â–¶'
		if (dom.runThinkingContent) dom.runThinkingContent.style.display = 'none'
	} else {
		if (dom.runThinking) dom.runThinking.style.display = 'none'
	}

	// æ“ä½œåˆ—è¡¨
	if (result.operations && result.operations.length > 0) {
		if (dom.runOperations) dom.runOperations.style.display = ''
		if (dom.runOperationsList) {
			dom.runOperationsList.innerHTML = ''
			for (const op of result.operations) {
				const opEl = document.createElement('div')
				opEl.className = 'flex items-center gap-2 text-xs p-1.5 rounded-md'
				opEl.style.cssText = 'background: oklch(var(--bc) / 0.03);'

				const statusIcon = op.success ? 'âœ…' : 'âŒ'
				const tagName = op.tag || op.type || 'unknown'
				const opType = op.opType || op.action || ''

				opEl.innerHTML = `
					<span>${statusIcon}</span>
					<span class="badge badge-xs badge-outline font-mono">${escapeHtml(tagName)}</span>
					<span class="font-mono text-base-content/60">${escapeHtml(opType)}</span>
					${op.path ? `<span class="text-base-content/40 truncate">${escapeHtml(op.path)}</span>` : ''}
					${op.error ? `<span class="text-error text-xs">${escapeHtml(op.error)}</span>` : ''}
				`
				dom.runOperationsList.appendChild(opEl)
			}
		}
	} else {
		if (dom.runOperations) dom.runOperations.style.display = 'none'
	}

	// AI å›å¤
	if (dom.runReply) dom.runReply.style.display = ''
	if (dom.runReplyContent) dom.runReplyContent.textContent = result.reply || 'ï¼ˆæ— å›å¤å†…å®¹ï¼‰'

	// æ¸…é™¤é”™è¯¯
	if (dom.runError) dom.runError.style.display = 'none'
}

function renderRunError(errorMsg) {
	if (dom.runError) dom.runError.style.display = ''
	if (dom.runErrorContent) dom.runErrorContent.textContent = `âŒ ${errorMsg}`
	if (dom.runReply) dom.runReply.style.display = 'none'
	if (dom.runThinking) dom.runThinking.style.display = 'none'
	if (dom.runOperations) dom.runOperations.style.display = 'none'
}

/** HTML è½¬ä¹‰ */
function escapeHtml(str) {
	const div = document.createElement('div')
	div.textContent = str
	return div.innerHTML
}

// ===== åˆå§‹åŒ– =====

export async function init() {
	console.log('[memoryPreset] åˆå§‹åŒ–è®°å¿†é¢„è®¾ç®¡ç†...')

	cacheDom()
	bindEvents()

	// å…ˆåŠ è½½ AI æœåŠ¡æºåˆ—è¡¨
	aiSourceList = await fetchAISourceList()
	console.log(`[memoryPreset] è·å–åˆ° ${aiSourceList.length} ä¸ª AI æœåŠ¡æº`)

	await refreshPresets()

	// éšè— loadingï¼Œæ˜¾ç¤ºä¸»å†…å®¹
	if (dom.loading) dom.loading.style.display = 'none'
	if (dom.main) dom.main.style.display = ''

	console.log(`[memoryPreset] åŠ è½½äº† ${presets.length} ä¸ªè®°å¿†é¢„è®¾`)
}