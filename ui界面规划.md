# 贝露·与你之诗 — 项目蓝图

> **项目名称**: beilu（贝露·与你之诗）  
> **核心目标**: 永远记忆  
> **方法论**: 借助 Fount → 仿照 → 自创 → 超越  
> **品牌**: beilu — 不是 fount 的插件，是独立项目  
> 更新时间: 2026-02-16

---

## 〇、项目定位

beilu 不是一个聊天前端，也不是 SillyTavern 的替代品。

**beilu 是一个让 AI 拥有永久记忆的智能体平台。**

对话只是表层。记忆才是核心。

我们要做的是：让你和 AI 之间的每一次对话、每一个细节，都被记住、被理解、被关联。不是"上下文窗口"那种临时记忆，是真正的、跨越时间的、会自己整理和回忆的记忆。

### 我们有什么

| 层级     | 来源                   | 说明                                 |
| -------- | ---------------------- | ------------------------------------ |
| 运行环境 | Fount (Deno + Express) | 仿照、改造、适配为 beilu 引擎        |
| 对接能力 | SillyTavern 兼容       | 角色卡、预设、世界书的导入导出       |
| AI 接入  | 多 API 源              | Gemini、OpenAI 兼容格式、本地模型    |
| 额外服务 | Fount 扩展             | 搜索联网、翻译、Discord/Telegram Bot |

### 我们要做什么

| 层级       | 名称     | 创新度     | 说明                                         |
| ---------- | -------- | ---------- | -------------------------------------------- |
| 第一层     | 首页     | 🔵 改造     | 角色卡管理、系统设置、API 配置               |
| 第二层     | 聊天     | 🟡 重写     | 对话引擎、预设系统、美化渲染                 |
| 第三层     | 控制     | 🟡 新增     | 文件管理、MCP、AI 后台、终端                 |
| **第四层** | **记忆** | 🔴 **原创** | **RAG + KV Memory + Vector DB + 多 AI 配合** |

---

## 一、四层架构

### 第一层：首页（管理界面）

```
┌─────────────────────────────────────────────────────┐
│  使用          系统和功能设置           用户设置      │ ← 顶部导航
├──────────┬──────────────────────┬───────────────────┤
│          │                      │                   │
│  角色卡   │    内容展示区         │   快捷操作        │
│  世界书   │    (选中项详情)       │   导入/导出       │
│  用户人设 │                      │   Bot 管理        │
│  预设管理 │                      │   设备访问        │
│          │                      │   调试面板        │
│          │                      │                   │
└──────────┴──────────────────────┴───────────────────┘
```

**核心改动**（相对 Fount 原版）：

- ❌ 删除：成就系统、教程
- ✅ 重组：角色卡/世界书/用户人设 拆分到左侧独立面板
- ✅ 简化：API 配置合并到角色卡层级（不在首页单独展示）
- ✅ 保留：Bot 管理（Discord/Telegram）、浏览器集成、桌面宠物、调试面板
- ✅ 增强：调试面板可查看完整提示词内容（类似酒馆的 prompt viewer）

### 第二层：聊天（对话界面）

```
┌─────────────────────────────────────────────────────┐
│  ← 返回          角色名称             设置 ⚙        │ ← 顶部
├──────────┬──────────────────────┬───────────────────┤
│          │                      │                   │
│  预设设置 │    对话区域           │  记忆 AI 设置     │
│  ·条目管理│    ·消息列表          │  ·AI 提示词       │
│  ·导入导出│    ·流式输出          │  ·API 选择        │
│  ·快捷开关│    ·美化渲染          │  ·权限设置        │
│          │                      │                   │
│  模型参数 │    ──────────         │  对话 AI 设置     │
│  ·温度    │    输入框 + 发送      │  ·权限设置        │
│  ·Top P/K │                      │  ·外部应用        │
│  ·惩罚参数│                      │  ·联网/文件/MCP   │
│          │                      │  ·Bot 绑定        │
└──────────┴──────────────────────┴───────────────────┘
```

**核心改动**：

- ✅ 角色卡打开 = 加载上次对话（不是新建空白聊天）
- ✅ 预设条目的快捷开关组（保存当前状态，一键切换场景）
- ✅ 美化系统：正则渲染、思维链折叠、HTML 占位符保护
- ✅ 记忆 AI 和对话 AI 独立配置
- ✅ AI 自主性：不是被动工具，而是主动智能体

### 第三层：控制（AI 工作台）

```
┌─────────────────────────────────────────────────────┐
│  文件浏览器    终端    MCP    后台日志    任务       │ ← 标签页
├─────────────────────────────────────────────────────┤
│                                                     │
│  类似 VS Code / Cursor 的文件管理界面               │
│  ·文件树浏览                                        │
│  ·文件创建、编辑、删除                              │
│  ·AI 可以操作文件（有权限控制）                      │
│  ·MCP 服务管理和调用                                │
│  ·后台日志实时查看                                  │
│                                                     │
└─────────────────────────────────────────────────────┘
```

**核心特点**：

- AI 拥有受控的文件系统访问权限
- MCP 协议支持（Browser MCP 等）
- 终端能力（受限的命令执行）
- 后台日志和调试信息实时展示

### 第四层：记忆（核心创新 — 永远记忆）

> **这是 beilu 的灵魂。所有前三层都是为第四层服务的。**

```
┌──────────────────────────────────────────────────────────────┐
│                     记忆层架构                                │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐               │
│  │ 注入层    │    │ 钩子层    │    │ 长期层    │               │
│  │(每轮注入) │    │(AI辅助)  │    │(日/月/年) │               │
│  └────┬─────┘    └────┬─────┘    └────┬─────┘               │
│       │               │               │                      │
│  ┌────▼───────────────▼───────────────▼─────┐               │
│  │          beilu 记忆引擎                    │               │
│  │  ┌─────────┐  ┌──────────┐  ┌──────────┐ │               │
│  │  │ KV Store │  │ Vector DB│  │ RAG 引擎 │ │               │
│  │  │(实体/事实)│  │(语义检索)│  │(检索增强)│ │               │
│  │  └─────────┘  └──────────┘  └──────────┘ │               │
│  └──────────────────────────────────────────┘               │
│                         │                                    │
│  ┌──────────────────────▼──────────────────────┐            │
│  │              多 AI 协作层                     │            │
│  │  记忆 AI ←→ 对话 AI ←→ 检索 AI               │            │
│  └─────────────────────────────────────────────┘            │
└──────────────────────────────────────────────────────────────┘
```

#### 记忆文件分层

| 层级 | 名称         | 注入方式         | 内容                             | Token 类型 |
| ---- | ------------ | ---------------- | -------------------------------- | ---------- |
| L0   | **注入层**   | 每轮都注入上下文 | 核心设定、当天表格记忆           | 🔴 热 Token |
| L1   | **钩子层**   | AI 辅助按需注入  | 关联记忆、用户信息、事件回忆     | 🟡 温 Token |
| L2   | **长期层**   | 按日/月/年归档   | 每日总结、月度总结、年度总结     | 🔵 冷 Token |
| L3   | **自定义层** | 用户可加减       | "贝露永远记住的事情"等自定义条目 | 🟡 温 Token |

#### 记忆机制

**当天记忆**：

- 每次对话做简短记录
- 超过 50 条（可调）→ 整理合并
- 当天结束 → 生成昨日总结

**月度归档**：

- 每月结束 → 生成月总结
- 每天细节压缩为 ≤500 字的日总结
- 文件按月归档

**钩子记忆**（AI 辅助检索）：

- 辅助 AI 读取当前对话上下文
- 对照顶层总结（近 30 天）
- 按关联性检索深层记忆
- 注入到对话 AI 的上下文中

#### 核心技术

| 技术            | 用途            | 说明                                       |
| --------------- | --------------- | ------------------------------------------ |
| **RAG**         | 检索增强生成    | 对话时自动检索相关记忆片段                 |
| **KV Memory**   | 事实/实体数据库 | "贝露喜欢蓝色"、"主人的生日是X月X日"       |
| **Vector DB**   | 向量数据库      | 语义相似度检索，找到"感觉相关"的记忆       |
| **冷/热 Token** | Token 分级管理  | 热 Token 每轮注入，冷 Token 按需检索       |
| **多 AI 配合**  | 分工协作        | 记忆 AI 整理 + 对话 AI 交流 + 检索 AI 匹配 |

#### 瞬时记忆

可以用正则实现的轻量级记忆：

- 提取对话中的关键信息（名字、日期、事件）
- 即时写入 KV Store
- 无需等待 AI 总结

---

## 二、与 Fount 的关系

### 方法论：借助 → 仿照 → 自创 → 超越

```
Fount 提供的                    beilu 的做法
─────────────                   ──────────
Deno + Express 运行环境         ✅ 继续使用，改品牌为 beilu
用户认证 (auth)                 ✅ 继续使用
模块加载 (parts_loader)         ✅ 继续使用
AI Source (proxy/gemini)        ✅ 继续使用
WebSocket 实时通信              ✅ 继续使用
搜索/翻译服务                   ✅ 继续使用
Discord/Telegram Bot            ✅ 继续使用
聊天引擎 (chat.mjs)            🔄 仿照 → 重写 → 替代
成就系统                        ❌ 删除
多角色自动回复                  ❌ 删除（如需则自己实现）
timeSlice 复杂状态机            ❌ 简化
is_VividChat greeting 过滤     ❌ 删除
```

### 品牌重塑计划

| 项目     | 原来                   | 改为                                |
| -------- | ---------------------- | ----------------------------------- |
| 网址显示 | `/parts/shells:fount/` | `/parts/shells:beilu/` 或 `/beilu/` |
| 项目名称 | Fount (泉)             | beilu (贝露·与你之诗)               |
| 后台标识 | fount                  | beilu                               |
| 代码仓库 | fount 的 GitHub        | 自有仓库（待建）                    |

---

## 三、功能模块清单

### 已完成 ✅

| 模块       | 说明                              | 版本  |
| ---------- | --------------------------------- | ----- |
| 预设系统   | ST 预设导入 + 司令员模式          | v13.6 |
| 世界书系统 | 条目管理 + 关键词/常驻激活        | v13.5 |
| 美化系统   | 正则渲染 + 思维链折叠 + HTML 保护 | v15.5 |
| 角色卡导入 | JSON/PNG + beilu 模板 + 删除      | v14   |
| API 配置   | 多源切换 + 持久化                 | v13   |
| 调试工具   | 伪发送预览（fake-send）           | v15   |

### 进行中 🔄

| 模块         | 说明                                 | 状态       |
| ------------ | ------------------------------------ | ---------- |
| 聊天引擎重写 | chat.mjs 简化版（修复开场白 bug 等） | 方案已确认 |
| 品牌重塑     | 网址/标识改为 beilu                  | 规划中     |

### 待开发 📋

| 优先级 | 模块           | 说明                                  |
| ------ | -------------- | ------------------------------------- |
| P0     | 聊天引擎       | 替代 Fount chat.mjs，修复所有已知 bug |
| P0     | 开场白修复     | 在新引擎中直接解决                    |
| P1     | 图片收发       | 对话中发送/接收图片                   |
| P1     | 瞬时记忆       | 正则提取关键信息 → KV Store           |
| P2     | 文件管理       | 类 Cursor 的文件浏览/编辑界面         |
| P2     | MCP 集成       | Browser MCP 等协议支持                |
| P3     | **记忆引擎**   | KV Memory + 注入/钩子/长期层          |
| P3     | **RAG 引擎**   | 检索增强生成                          |
| P3     | **向量数据库** | 语义检索                              |
| P3     | **多 AI 配合** | 记忆 AI + 对话 AI + 检索 AI           |
| P4     | 冷/热 Token    | Token 分级管理和优化                  |
| P4     | 月度归档       | 自动整理和压缩历史记忆                |

---

## 四、技术参考

### 相关文档

| 文档                                                     | 内容                                     |
| -------------------------------------------------------- | ---------------------------------------- |
| [`beilu_worklog_架构审查.md`](beilu_worklog_架构审查.md) | Fount chat.mjs 问题分析 + 新引擎设计方案 |
| [`beilu_worklog_与你之诗.md`](beilu_worklog_与你之诗.md) | 开发日志（历史记录）                     |
| [`AUDIT_REPORT.md`](AUDIT_REPORT.md)                     | Fount 框架解构 + 每个模块的说明          |
| [`AGENTS.md`](AGENTS.md)                                 | 模块技术细节和 AI agent 说明             |

---

> **一切都是为了第四层。**  
> **让 AI 真正记住你。**
